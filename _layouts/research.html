<!DOCTYPE html>
<html lang="en" class="no-js">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page.title }} - CoMPhy Lab</title>

  <script>
    document.documentElement.classList.remove('no-js');
    document.documentElement.classList.add('js');
  </script>

  <!-- Font dependencies -->
  <link rel="stylesheet" href="/assets/css/fontello/css/fontello.css">
  <link rel="stylesheet" href="/assets/css/academicons-1.7.0/css/academicons.min.css">
  <!-- Site styles -->
  <link rel="stylesheet" href="/assets/css/vendor.css">
  <link rel="stylesheet" href="/assets/css/styles.css">
  <link rel="stylesheet" href="/assets/css/research.css">
  <script>
    // Check if we're on localhost
    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
      // Use official Font Awesome CDN for local development with version 6.7.2
      document.write('<link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.7.2/css/all.css" crossorigin="anonymous">');
    } else {
      // Use Kit for production
      document.write('<script src="https://kit.fontawesome.com/b1cfd9ca75.js" crossorigin="anonymous"><\/script>');
    }
  </script>
</head>
<body id="top">

  <div id="preloader">
    <div id="loader"></div>
  </div>

  <div id="page" class="s-pagewrap">
    <header class="s-header">
      <div class="s-header__logo">
        <a class="logo" href="/">
          <img src="/assets/logos/CoMPhy-Lab-no-name.png" alt="CoMPhy Lab">
        </a>
      </div>
      <a class="s-header__menu-toggle" href="#0">
        <span class="s-header__menu-text">Menu</span>
        <span class="s-header__menu-icon"></span>
      </a>
      <nav class="s-header__nav">
        <a href="#0" class="s-header__nav-close-btn"><span>Close</span></a>
        <ul class="s-header__nav-list">
          <li style="background: none;"><a href="https://scholar.google.com/citations?user=67aQviYAAAAJ" style="background: none; padding: 0;"><i class="ai ai-google-scholar" style="font-size: 1.75em;"></i></a></li>
          <li style="background: none;"><a href="https://github.com/comphy-lab" style="background: none; padding: 0;"><i class="fa-brands fa-github" style="font-size: 1.75em;"></i></a></li>
          <li><a href="/#about">About</a></li>
          <li><a href="/team">Team</a></li>
          <li><a href="/research">Research</a></li>
          <li><a href="https://publish.obsidian.md/comphy-lab/README" target="_blank">Blog</a></li>
          <li style="background: none;"><a href="https://bsky.app/profile/comphy-lab.org" style="background: none; padding: 0;"><i class="fa-brands fa-bluesky" style="font-size: 1.75em; color: #0085ff;"></i></a></li>
        </ul>
      </nav>
    </header>

    <!-- Research Section -->
    <section class="s-research">
      <div class="row">
        <div class="research-layout">
          <div class="toc-sidebar">
            <nav class="toc-nav">
              <h3>Contents</h3>
              <ul class="toc-list">
                <!-- Will be populated by JavaScript -->
              </ul>
            </nav>
          </div>
          <div class="research-content markdown-content">
            {{ content | replace: '<iframe', '<div class="video-container"><iframe loading="lazy"' | replace: '</iframe>', '</iframe></div>' }}
          </div>
        </div>
      </div>
    </section>

    <footer class="site-footer">
      <div class="footer-left">
        <a href="http://basilisk.fr/sandbox/vatsal/" target="_blank">
          <img src="/assets/logos/logoBasilisk_TransparentBackground.png" alt="Basilisk C" class="footer-logo">
        </a>
        <a href="https://pof.tnw.utwente.nl/" target="_blank">
          <img src="/assets/logos/LogoPof_transparent_white.png" alt="Physics of Fluids" class="footer-logo pof-logo">
        </a>
        <a href="https://www.utwente.nl/" target="_blank">
          <img src="/assets/logos/UT_Logo_2400_Sta_White_EN.png" alt="University of Twente" class="footer-logo">
        </a>
      </div>
      <div class="footer-center">
        <p class="copyright-text">
          &copy; Copyright<br>
          CoMPhy Lab 2025
        </p>
      </div>
      <div class="footer-right">
        <a href="https://scholar.google.com/citations?user=67aQviYAAAAJ" target="_blank">
          <i class="ai ai-google-scholar" style="font-size: 2.5em; color: white;"></i>
        </a>
        <a href="https://github.com/comphy-lab" target="_blank">
          <i class="fa-brands fa-github" style="font-size: 2.5em; color: white;"></i>
        </a>
        <a href="https://www.youtube.com/@VatsalSanjay" target="_blank">
          <i class="fa-brands fa-youtube" style="font-size: 2.5em; color: white;"></i>
        </a>
        <a href="https://bsky.app/profile/comphy-lab.org" target="_blank">
          <i class="fa-brands fa-bluesky" style="font-size: 2.5em; color: white;"></i>
        </a>
        <a href="https://github.com/comphy-lab/comphy-lab.github.io" class="edit-link">
          <i class="fa-brands fa-github"></i> Edit this page
        </a>
      </div>
    </footer>

    <div class="ss-go-top">
      <a class="smoothscroll" title="Back to Top" href="#top">
          <i class="fa-solid fa-arrow-up"></i>
      </a>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="/assets/js/main.js"></script>
  <script>
    // Add badge container around consecutive badge links
    document.addEventListener('DOMContentLoaded', function() {
      // Generate table of contents
      const tocList = document.querySelector('.toc-list');
      const headings = document.querySelectorAll('.research-content h2');
      const tocEntries = [];

      headings.forEach((heading, index) => {
        // Create an ID if it doesn't exist
        if (!heading.id) {
          heading.id = `section-${index}`;
        }

        // Create TOC entry
        const li = document.createElement('li');
        const a = document.createElement('a');
        a.href = `#${heading.id}`;
        a.textContent = heading.textContent;
        li.appendChild(a);
        tocList.appendChild(li);
        tocEntries.push({ element: heading, link: a });
      });

      // Handle scroll and highlight active section
      const observerOptions = {
        root: null,
        rootMargin: '-100px 0px -66%',
        threshold: 0
      };

      const headingObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          const index = Array.from(headings).indexOf(entry.target);
          const link = tocEntries[index].link;

          if (entry.isIntersecting) {
            // Remove all active classes first
            tocEntries.forEach(item => item.link.classList.remove('active'));
            // Add active class to current section
            link.classList.add('active');
          }
        });
      }, observerOptions);

      // Observe all h2 headings
      headings.forEach(heading => headingObserver.observe(heading));

      // Smooth scroll to section when clicking TOC links
      tocList.addEventListener('click', (e) => {
        if (e.target.tagName === 'A') {
          e.preventDefault();
          const targetId = e.target.getAttribute('href').slice(1);
          const targetElement = document.getElementById(targetId);
          
          if (targetElement) {
            targetElement.scrollIntoView({
              behavior: 'smooth',
              block: 'start'
            });
          }
        }
      });

      // Wrap paper sections in containers
      const researchContent = document.querySelector('.research-content');
      const h3Elements = researchContent.querySelectorAll('h3');
      
      h3Elements.forEach((h3, index) => {
        // Create container
        const container = document.createElement('div');
        container.className = 'paper-container';
        
        // Insert container before current h3
        h3.parentNode.insertBefore(container, h3);
        
        // Move h3 into container
        container.appendChild(h3);
        
        // Move all elements until next h3 or end into container
        let currentElement = container.nextSibling;
        while (currentElement && 
               !(currentElement.tagName === 'H3' || currentElement.tagName === 'H2')) {
          const nextElement = currentElement.nextSibling;
          container.appendChild(currentElement);
          currentElement = nextElement;
        }
      });

      // Rest of your existing code...
      const paragraphs = researchContent.getElementsByTagName('p');
      
      for (let p of paragraphs) {
        if (p.querySelectorAll('a img[src*="shields.io"]').length > 0) {
          const badgeContainer = document.createElement('div');
          badgeContainer.className = 'badge-container';
          while (p.firstChild) {
            badgeContainer.appendChild(p.firstChild);
          }
          p.appendChild(badgeContainer);
        }
      }

      // Add copy buttons to paper titles
      document.querySelectorAll('.research-content h3').forEach(titleEl => {
        // Create container
        const container = document.createElement('div');
        container.className = 'paper-title-container';
        
        // Move the title into the container
        titleEl.parentNode.insertBefore(container, titleEl);
        container.appendChild(titleEl);
        
        // Add copy button
        const copyBtn = document.createElement('button');
        copyBtn.className = 'copy-button';
        copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
        copyBtn.setAttribute('aria-label', 'Copy citation');
        copyBtn.onclick = async (e) => {
          e.preventDefault();
          
          // Get the citation text (title + next paragraph)
          const citation = titleEl.textContent + ' ' + 
            (titleEl.nextElementSibling?.textContent || '');
          
          try {
            await navigator.clipboard.writeText(citation);
            
            // Show success feedback
            copyBtn.innerHTML = '<i class="fa-solid fa-check"></i>';
            copyBtn.classList.add('copy-success');
            
            // Reset after animation
            setTimeout(() => {
              copyBtn.innerHTML = '<i class="fa-regular fa-copy"></i>';
              copyBtn.classList.remove('copy-success');
            }, 1000);
          } catch (err) {
            console.error('Failed to copy:', err);
          }
        };
        container.appendChild(copyBtn);
      });

      // Add intersection observer for animations
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.style.opacity = '1';
            entry.target.style.transform = 'translateY(0)';
            observer.unobserve(entry.target);
          }
        });
      }, {
        threshold: 0.1
      });

      // Observe all major elements
      document.querySelectorAll('.research-content > h2, .research-content > h3, .video-container').forEach(el => {
        el.style.opacity = '0';
        el.style.transform = 'translateY(20px)';
        el.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out';
        observer.observe(el);
      });
    });

    // Lazy load videos when they come into view
    document.addEventListener('DOMContentLoaded', function() {
      const lazyVideos = document.querySelectorAll('iframe[loading="lazy"]');
      const videoObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const iframe = entry.target;
            const src = iframe.getAttribute('src');
            if (src) {
              iframe.setAttribute('src', src);
            }
            videoObserver.unobserve(iframe);
          }
        });
      });

      lazyVideos.forEach(video => {
        videoObserver.observe(video);
      });

      // Handle tag filtering
      const allTags = document.querySelectorAll('.research-content tags span');
      const paperContainers = document.querySelectorAll('.paper-container');
      let activeTag = null;

      // Check URL for tag parameter
      const urlParams = new URLSearchParams(window.location.search);
      const tagFromUrl = urlParams.get('tag');

      // Function to highlight/unhighlight all matching tags
      const updateMatchingTags = (tagText, shouldHighlight) => {
        document.querySelectorAll('.research-content tags span').forEach(tag => {
          if (tag.textContent === tagText) {
            if (shouldHighlight) {
              tag.classList.add('active');
            } else {
              tag.classList.remove('active');
            }
          }
        });
      };

      allTags.forEach(tag => {
        tag.addEventListener('click', () => {
          const tagText = tag.textContent;
          
          // If clicking the active tag, deactivate it
          if (activeTag === tagText) {
            activeTag = null;
            // Remove active class from all tags
            updateMatchingTags(tagText, false);
            paperContainers.forEach(container => container.classList.remove('hidden'));
            history.pushState({}, '', window.location.pathname);
            return;
          }

          // Update active tag
          activeTag = tagText;
          
          // Remove active class from all tags first
          allTags.forEach(t => t.classList.remove('active'));
          // Then highlight all matching tags
          updateMatchingTags(tagText, true);

          // Update URL
          history.pushState({}, '', `?tag=${encodeURIComponent(tagText)}`);

          // Filter papers
          paperContainers.forEach(container => {
            const containerTags = container.querySelector('tags');
            if (containerTags && containerTags.textContent.includes(tagText)) {
              container.classList.remove('hidden');
            } else {
              container.classList.add('hidden');
            }
          });
        });
      });

      // Apply filter from URL if present
      if (tagFromUrl) {
        const matchingTag = Array.from(allTags).find(tag => tag.textContent === tagFromUrl);
        if (matchingTag) {
          matchingTag.click();
        }
      }
    });
  </script>
</body>
</html>